import asyncio
import aiohttp
import random
import json
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
import logging

# === –í–ê–®–ò –ö–õ–Æ–ß–ò ===
TOKEN = "8464793187:AAFd3MNyXWwX4g9bAZrPvVEVrZcz0GqcbjA"
AI_KEY = "AIzaSyDQsQynmKLfiQCwXyfsqNB45a7ctSwCjyA"
# ===================

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO, format="%(message)s")
logger = logging.getLogger(__name__)

# –ë–æ—Ç —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
bot = Bot(token=TOKEN, timeout=60)
dp = Dispatcher()

async def force_cleanup():
    """–ñ–µ—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"""
    print("üîÑ –í–´–ü–û–õ–ù–Ø–Æ –ñ–ï–°–¢–ö–£–Æ –û–ß–ò–°–¢–ö–£...")
    
    temp_bot = Bot(token=TOKEN)
    
    try:
        # 1. –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞
        for i in range(5):
            try:
                await temp_bot.delete_webhook(drop_pending_updates=True)
                print(f"  ‚úÖ –í–µ–±—Ö—É–∫ —É–¥–∞–ª–µ–Ω ({i+1}/5)")
                await asyncio.sleep(0.3)
            except:
                pass
        
        # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —Å—Ä–∞–∑—É —É–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫
        try:
            await temp_bot.set_webhook(
                url="https://example.com/force_reset",
                drop_pending_updates=True
            )
            await asyncio.sleep(0.5)
            await temp_bot.delete_webhook(drop_pending_updates=True)
            print("  ‚úÖ –í–µ–±—Ö—É–∫ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        except:
            pass
        
        # 3. –ü–æ–ª—É—á–∞–µ–º –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        try:
            updates = await temp_bot.get_updates(limit=1, timeout=1)
            if updates:
                last_id = updates[-1].update_id
                await temp_bot.get_updates(offset=last_id + 100, timeout=1)
                print(f"  ‚úÖ Offset —Å–±—Ä–æ—à–µ–Ω –¥–æ {last_id + 100}")
        except:
            pass
        
        # 4. –î–æ–ª–≥–∞—è –ø–∞—É–∑–∞ –¥–ª—è Telegram
        print("  ‚è≥ –ñ–¥—É 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤ Telegram...")
        await asyncio.sleep(5)
        
    finally:
        await temp_bot.session.close()
    
    print("‚úÖ –û–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê\n")

async def get_gemini_prediction(match_name):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –æ—Ç Gemini AI"""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–±–æ—á—É—é –º–æ–¥–µ–ª—å
    model = "gemini-flash-latest"
    url = f"https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={AI_KEY}"
    
    # –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    prompt = f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ—É—Ç–±–æ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–∞—Ç—á: {match_name}

–î–ê–ô –û–¢–í–ï–¢ –¢–û–õ–¨–ö–û –í –≠–¢–û–ú –§–û–†–ú–ê–¢–ï:

**–ü–†–û–ì–ù–û–ó –ù–ê –ú–ê–¢–ß {match_name.upper()}**

üèÜ **–í–ï–†–û–Ø–¢–ù–´–ô –ü–û–ë–ï–î–ò–¢–ï–õ–¨:** [–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã]
‚öΩ **–ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–ú–´–ô –°–ß–ï–¢:** [–Ω–∞–ø—Ä–∏–º–µ—Ä: 2-1]
üîë **–ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–û–†–´:**
‚Ä¢ [–ü–µ—Ä–≤—ã–π —Ñ–∞–∫—Ç–æ—Ä]
‚Ä¢ [–í—Ç–æ—Ä–æ–π —Ñ–∞–∫—Ç–æ—Ä]
‚Ä¢ [–¢—Ä–µ—Ç–∏–π —Ñ–∞–∫—Ç–æ—Ä]
üí° **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** [–ö—Ä–∞—Ç–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –º–∞—Ç—á—É]

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –±—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤."""
    
    payload = {
        "contents": [{
            "parts": [{"text": prompt}]
        }],
        "generationConfig": {
            "temperature": 0.7,
            "topP": 0.8,
            "maxOutputTokens": 350
        }
    }
    
    headers = {"Content-Type": "application/json"}
    
    try:
        print(f"ü§ñ –ó–∞–ø—Ä–æ—Å –∫ Gemini: '{match_name}'")
        async with aiohttp.ClientSession() as session:
            async with session.post(url, json=payload, headers=headers, timeout=20) as resp:
                if resp.status == 200:
                    data = await resp.json()
                    if 'candidates' in data and len(data['candidates']) > 0:
                        prediction = data['candidates'][0]['content']['parts'][0]['text']
                        print(f"‚úÖ Gemini –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ")
                        return prediction
                    else:
                        print(f"‚ö†Ô∏è Gemini –Ω–µ –≤–µ—Ä–Ω—É–ª –ø—Ä–æ–≥–Ω–æ–∑")
                        return None
                else:
                    error_data = await resp.json()
                    error_msg = error_data.get('error', {}).get('message', 'Unknown')
                    print(f"‚ùå –û—à–∏–±–∫–∞ Gemini: {error_msg[:80]}")
                    return None
    except asyncio.TimeoutError:
        print("‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini")
        return None
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")
        return None

def generate_quick_prediction(match_name):
    """–ë—ã—Å—Ç—Ä—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑"""
    # –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ç—á–µ–π
    match_lower = match_name.lower()
    
    # –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–∞—Ä—ã –∏ –∏—Ö –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –∏—Å—Ö–æ–¥—ã
    common_matches = {
        '—ç–≤–µ—Ä—Ç–æ–Ω –ª–∏–¥—Å': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–≠–≤–µ—Ä—Ç–æ–Ω',
            '—Å—á–µ—Ç': '2-1',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–î–æ–º–∞—à–Ω–∏–π —Å—Ç–∞–¥–∏–æ–Ω –≠–≤–µ—Ä—Ç–æ–Ω–∞', '–û–ø—ã—Ç –®–æ–Ω–∞ –î–∞–π—á–∞', '–ü—Ä–æ–±–ª–µ–º—ã –õ–∏–¥—Å –≤ –∑–∞—â–∏—Ç–µ']
        },
        '–±–∞—Ä—Å–µ–ª–æ–Ω–∞ —Ä–µ–∞–ª –º–∞–¥—Ä–∏–¥': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–†–µ–∞–ª –ú–∞–¥—Ä–∏–¥',
            '—Å—á–µ—Ç': '2-1',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–ú–æ—Ç–∏–≤–∞—Ü–∏—è –†–µ–∞–ª–∞', '–§–æ—Ä–º–∞ –í–∏–Ω–∏—Å–∏—É—Å–∞', '–ü—Ä–æ–±–ª–µ–º—ã –ë–∞—Ä—Å–µ–ª–æ–Ω—ã –≤ –∑–∞—â–∏—Ç–µ']
        },
        '—Ä–µ–∞–ª –º–∞–¥—Ä–∏–¥ –±–∞—Ä—Å–µ–ª–æ–Ω–∞': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–†–µ–∞–ª –ú–∞–¥—Ä–∏–¥',
            '—Å—á–µ—Ç': '2-1',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–ú–æ—Ç–∏–≤–∞—Ü–∏—è –†–µ–∞–ª–∞', '–§–æ—Ä–º–∞ –í–∏–Ω–∏—Å–∏—É—Å–∞', '–ü—Ä–æ–±–ª–µ–º—ã –ë–∞—Ä—Å–µ–ª–æ–Ω—ã –≤ –∑–∞—â–∏—Ç–µ']
        },
        '–∞—Ä—Å–µ–Ω–∞–ª —á–µ–ª—Å–∏': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–ê—Ä—Å–µ–Ω–∞–ª',
            '—Å—á–µ—Ç': '2-0',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–§–æ—Ä–º–∞ –ê—Ä—Å–µ–Ω–∞–ª–∞ –¥–æ–º–∞', '–ü—Ä–æ–±–ª–µ–º—ã –ß–µ–ª—Å–∏', '–ú–æ–ª–æ–¥–æ—Å—Ç—å –ê—Ä—Å–µ–Ω–∞–ª–∞']
        },
        '–º–∞–Ω—á–µ—Å—Ç–µ—Ä —é–Ω–∞–π—Ç–µ–¥ –ª–∏–≤–µ—Ä–ø—É–ª—å': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–õ–∏–≤–µ—Ä–ø—É–ª—å',
            '—Å—á–µ—Ç': '1-2',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–§–æ—Ä–º–∞ –õ–∏–≤–µ—Ä–ø—É–ª—è', '–ü—Ä–æ–±–ª–µ–º—ã –Æ–Ω–∞–π—Ç–µ–¥', '–¢–∞–∫—Ç–∏–∫–∞ –ö–ª–æ–ø–ø–∞']
        },
        '–ª–∏–≤–µ—Ä–ø—É–ª—å –º–∞–Ω—á–µ—Å—Ç–µ—Ä —é–Ω–∞–π—Ç–µ–¥': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–õ–∏–≤–µ—Ä–ø—É–ª—å',
            '—Å—á–µ—Ç': '2-0',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–î–æ–º–∞—à–Ω–∏–π —Å—Ç–∞–¥–∏–æ–Ω', '–§–æ—Ä–º–∞ –°–∞–ª–∞—Ö–∞', '–ü—Ä–æ–±–ª–µ–º—ã –Æ–Ω–∞–π—Ç–µ–¥']
        },
        '–º–∞–Ω—á–µ—Å—Ç–µ—Ä —Å–∏—Ç–∏ –∞—Ä—Å–µ–Ω–∞–ª': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–ú–∞–Ω—á–µ—Å—Ç–µ—Ä –°–∏—Ç–∏',
            '—Å—á–µ—Ç': '3-1',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–î–æ–º–∞—à–Ω–∏–π —Å—Ç–∞–¥–∏–æ–Ω', '–ö–ª–∞—Å—Å –ì–≤–∞—Ä–¥–∏–æ–ª—ã', '–ö–æ–Ω—Ç—Ä–æ–ª—å –º—è—á–∞']
        },
        '–∑–µ–Ω–∏—Ç —Å–ø–∞—Ä—Ç–∞–∫': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–ó–µ–Ω–∏—Ç',
            '—Å—á–µ—Ç': '2-0',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–ö–∞—á–µ—Å—Ç–≤–æ —Å–æ—Å—Ç–∞–≤–∞', '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', '–î–æ–º–∞—à–Ω–∏–π —Å—Ç–∞–¥–∏–æ–Ω']
        },
        '—Å–ø–∞—Ä—Ç–∞–∫ –∑–µ–Ω–∏—Ç': {
            '–ø–æ–±–µ–¥–∏—Ç–µ–ª—å': '–ó–µ–Ω–∏—Ç',
            '—Å—á–µ—Ç': '1-2',
            '—Ñ–∞–∫—Ç–æ—Ä—ã': ['–ö–∞—á–µ—Å—Ç–≤–æ –ó–µ–Ω–∏—Ç–∞', '–ì–æ—Å—Ç–µ–≤–∞—è –∏–≥—Ä–∞', '–õ–µ–≥–∏–æ–Ω–µ—Ä—ã']
        }
    }
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–∞—Ç—á
    for key, value in common_matches.items():
        if key in match_lower or match_lower in key:
            factors = '\n'.join([f'‚Ä¢ {f}' for f in value['—Ñ–∞–∫—Ç–æ—Ä—ã']])
            return (
                f"‚öΩ **–ú–ê–¢–ß:** {match_name}\n\n"
                f"üèÜ **–í–ï–†–û–Ø–¢–ù–´–ô –ü–û–ë–ï–î–ò–¢–ï–õ–¨:** {value['–ø–æ–±–µ–¥–∏—Ç–µ–ª—å']}\n"
                f"üìç **–ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–ú–´–ô –°–ß–ï–¢:** {value['—Å—á–µ—Ç']}\n\n"
                f"üîë **–ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–û–†–´:**\n{factors}\n\n"
                f"üí° **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** –°—Ç–∞–≤–∫–∞ –Ω–∞ –ø–æ–±–µ–¥—É {value['–ø–æ–±–µ–¥–∏—Ç–µ–ª—å']}\n\n"
                f"üìä *–õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ | {datetime.now().strftime('%H:%M')}*"
            )
    
    # –ï—Å–ª–∏ –º–∞—Ç—á –Ω–µ –∏–∑–≤–µ—Å—Ç–µ–Ω - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π
    teams = match_name.split()
    if len(teams) >= 2:
        team1 = teams[0].title()
        team2 = teams[1].title()
    else:
        team1 = "–ü–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞"
        team2 = "–í—Ç–æ—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞"
    
    scores = ["1-0", "2-0", "2-1", "1-1", "0-0", "3-1", "1-2", "0-1"]
    factors_list = [
        "–§–æ—Ä–º–∞ –∫–æ–º–∞–Ω–¥ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–∞—Ç—á–∞—Ö",
        "–¢—Ä–∞–≤–º—ã –∫–ª—é—á–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤",
        "–¢–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–æ–≤",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è –≤ —Ç—É—Ä–Ω–∏—Ä–µ",
        "–ò—Å—Ç–æ—Ä–∏—è –ª–∏—á–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á",
        "–ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è",
        "–ù–∞—Å—Ç—Ä–æ–π —Ñ–∞–Ω–∞—Ç–æ–≤",
        "–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞"
    ]
    
    winner = random.choice([team1, team2])
    score = random.choice(scores)
    factors = random.sample(factors_list, 3)
    
    factors_text = '\n'.join([f'‚Ä¢ {f}' for f in factors])
    
    return (
        f"‚öΩ **–ú–ê–¢–ß:** {match_name}\n\n"
        f"üèÜ **–í–ï–†–û–Ø–¢–ù–´–ô –ü–û–ë–ï–î–ò–¢–ï–õ–¨:** {winner}\n"
        f"üìç **–ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–ú–´–ô –°–ß–ï–¢:** {score}\n\n"
        f"üîë **–ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–û–†–´:**\n{factors_text}\n\n"
        f"üí° **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** –ú–∞—Ç—á –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–≤–Ω—ã–º\n\n"
        f"üìä *–õ–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ | {datetime.now().strftime('%H:%M')}*"
    )

@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    await message.answer(
        "ü§ñ **–§–£–¢–ë–û–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–¢–ò–ö –° GEMINI AI** ‚öΩ\n\n"
        "‚úÖ *Gemini AI –∞–∫—Ç–∏–≤–µ–Ω!*\n\n"
        "üìù *–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–∞—Ç—á –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:*\n"
        "`–≠–≤–µ—Ä—Ç–æ–Ω –õ–∏–¥—Å`\n"
        "`–ë–∞—Ä—Å–µ–ª–æ–Ω–∞ –†–µ–∞–ª –ú–∞–¥—Ä–∏–¥`\n"
        "`–ú–∞–Ω—á–µ—Å—Ç–µ—Ä –Æ–Ω–∞–π—Ç–µ–¥ –õ–∏–≤–µ—Ä–ø—É–ª—å`\n"
        "`–ó–µ–Ω–∏—Ç –°–ø–∞—Ä—Ç–∞–∫`\n\n"
        "‚ö° *–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:*\n"
        "‚Ä¢ **Google Gemini AI** –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞\n"
        "‚Ä¢ –õ–æ–∫–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç\n"
        "‚Ä¢ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n\n"
        "üéØ *–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:*\n"
        "‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è\n"
        "‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω—ã–π —Å—á–µ—Ç\n"
        "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –º–∞—Ç—á–∞\n"
        "‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
        parse_mode="Markdown"
    )

@dp.message(Command("gemini"))
async def gemini_cmd(message: types.Message):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Gemini"""
    await message.answer("ü§ñ –¢–µ—Å—Ç–∏—Ä—É—é Gemini AI...")
    
    test_prediction = await get_gemini_prediction("–ë–∞—Ä—Å–µ–ª–æ–Ω–∞ –†–µ–∞–ª –ú–∞–¥—Ä–∏–¥ —Ç–µ—Å—Ç")
    
    if test_prediction:
        await message.answer(f"‚úÖ **GEMINI AI –†–ê–ë–û–¢–ê–ï–¢!**\n\n{test_prediction}", parse_mode="Markdown")
    else:
        await message.answer("‚ö†Ô∏è **Gemini –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**\n–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑", parse_mode="Markdown")

@dp.message(Command("reset"))
async def reset_cmd(message: types.Message):
    """–°–±—Ä–æ—Å –±–æ—Ç–∞"""
    await message.answer("üîÑ –í—ã–ø–æ–ª–Ω—è—é —Å–±—Ä–æ—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π...")
    await force_cleanup()
    await message.answer("‚úÖ –°–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω! –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.")

@dp.message()
async def handle_message(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    if not message.text or message.text.startswith('/'):
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    await bot.send_chat_action(message.chat.id, "typing")
    
    print(f"\nüì• –ó–∞–ø—Ä–æ—Å: '{message.text}'")
    
    try:
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º Gemini AI
        gemini_response = await get_gemini_prediction(message.text)
        
        if gemini_response:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç Gemini
            response = f"ü§ñ **GEMINI AI –ê–ù–ê–õ–ò–ó**\n\n{gemini_response}\n\n"
            response += f"üìÖ *–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω: {datetime.now().strftime('%d.%m.%Y %H:%M')}*"
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
            print("‚ö†Ô∏è Gemini –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –∏—Å–ø–æ–ª—å–∑—É—é –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑")
            response = generate_quick_prediction(message.text)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        await message.answer(response, parse_mode="Markdown")
        print(f"‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        # –ê–≤–∞—Ä–∏–π–Ω—ã–π –æ—Ç–≤–µ—Ç
        await message.answer(
            f"‚öΩ **–ú–ê–¢–ß:** {message.text}\n\n"
            f"‚ö†Ô∏è *–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞*\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç.\n\n"
            f"üí° *–°–æ–≤–µ—Ç:* `–≠–≤–µ—Ä—Ç–æ–Ω –õ–∏–¥—Å`",
            parse_mode="Markdown"
        )

async def main():
    """–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫"""
    print("=" * 60)
    print("üöÄ –ó–ê–ü–£–°–ö –ë–û–¢–ê –° GEMINI AI")
    print("=" * 60)
    
    # –ñ–µ—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
    await force_cleanup()
    
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º polling —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    try:
        await dp.start_polling(
            bot,
            skip_updates=True,
            allowed_updates=["message"],
            polling_timeout=60,  # –ë–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç
            relax=0.5,  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            handle_signals=True
        )
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
    finally:
        print("üîÑ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")

if __name__ == "__main__":
    asyncio.run(main())
