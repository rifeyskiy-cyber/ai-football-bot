import asyncio
import aiohttp
import json
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
TOKEN = "8464793187:AAFd3MNyXWwX4g9bAZrPvVEVrZcz0GqcbjA"
AI_KEY = "AIzaSyDgW7ONTdXO_yiVTYlGs4Y_Q5VaGP0sano"

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO, format="%(message)s")
logger = logging.getLogger(__name__)

# –ë–æ—Ç
bot = Bot(token=TOKEN)
dp = Dispatcher()

async def test_gemini_connection():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–∞–∑–Ω—ã–º –º–æ–¥–µ–ª—è–º Gemini"""
    print("\nüîç –¢–ï–°–¢–ò–†–£–Æ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö GEMINI API...")
    
    # –ú–æ–¥–µ–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∞ (–∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞)
    test_models = [
        "gemini-2.0-flash",
        "gemini-2.0-flash-001", 
        "gemini-flash-latest",
        "gemini-pro-latest",
        "gemini-2.5-flash",
        "gemini-2.5-pro",
        "gemini-2.0-flash-lite",
        "gemini-2.0-flash-exp"
    ]
    
    working_models = []
    
    for model in test_models:
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={AI_KEY}"
        
        payload = {
            "contents": [{
                "parts": [{
                    "text": "–ü—Ä–∏–≤–µ—Ç! –û—Ç–≤–µ—Ç—å 'OK' –µ—Å–ª–∏ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å."
                }]
            }],
            "generationConfig": {
                "maxOutputTokens": 10
            }
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(url, json=payload, timeout=5) as resp:
                    if resp.status == 200:
                        data = await resp.json()
                        print(f"‚úÖ {model}: –†–ê–ë–û–¢–ê–ï–¢")
                        working_models.append(model)
                    else:
                        error_data = await resp.json()
                        error_msg = error_data.get('error', {}).get('message', 'Unknown')
                        print(f"‚ùå {model}: –û—à–∏–±–∫–∞ {resp.status} - {error_msg[:50]}")
        except Exception as e:
            print(f"‚ö†Ô∏è {model}: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ - {str(e)[:50]}")
    
    print(f"\nüìä –ò–¢–û–ì: {len(working_models)} –∏–∑ {len(test_models)} –º–æ–¥–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞—é—Ç")
    return working_models

async def get_football_prediction(match_name):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Ñ—É—Ç–±–æ–ª—å–Ω—ã–π –º–∞—Ç—á"""
    
    # 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º Gemini API
    working_models = await test_gemini_connection()
    
    if working_models:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é —Ä–∞–±–æ—Ç–∞—é—â—É—é –º–æ–¥–µ–ª—å
        model = working_models[0]
        print(f"üéØ –ò—Å–ø–æ–ª—å–∑—É—é –º–æ–¥–µ–ª—å: {model}")
        
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={AI_KEY}"
        
        # –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ—É—Ç–±–æ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        prompt = f"""–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ñ—É—Ç–±–æ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–∞—Ç—á: {match_name}

–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞–π –ø—Ä–æ–≥–Ω–æ–∑:
1. –í–µ—Ä–æ—è—Ç–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –∏ –ø–æ—á–µ–º—É
2. –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Å—á–µ—Ç
3. –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤–ª–∏—è—é—Ç –Ω–∞ –∏–≥—Ä—É

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)."""
        
        payload = {
            "contents": [{
                "parts": [{"text": prompt}]
            }],
            "generationConfig": {
                "temperature": 0.7,
                "topP": 0.8,
                "topK": 40,
                "maxOutputTokens": 300
            }
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(url, json=payload, timeout=15) as resp:
                    if resp.status == 200:
                        data = await resp.json()
                        if 'candidates' in data and len(data['candidates']) > 0:
                            prediction = data['candidates'][0]['content']['parts'][0]['text']
                            print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç {model}")
                            return prediction
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ {model}: {e}")
    
    # 2. –ï—Å–ª–∏ Gemini –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
    print("‚ö†Ô∏è Gemini API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—é –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É")
    return generate_local_prediction(match_name)

def generate_local_prediction(match_name):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏"""
    match_lower = match_name.lower()
    
    # –°–ª–æ–≤–∞—Ä—å –∫–æ–º–∞–Ω–¥ –∏ –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
    teams = {
        # –ê–Ω–≥–ª–∏–π—Å–∫–∞—è –ü—Ä–µ–º—å–µ—Ä-–ª–∏–≥–∞
        '–º–∞–Ω—á–µ—Å—Ç–µ—Ä —Å–∏—Ç–∏': {'—Å–∏–ª–∞': 95, '–∞—Ç–∞–∫–∞': 97, '–∑–∞—â–∏—Ç–∞': 93, '—Ç—Ä–µ–Ω–µ—Ä': '–ü–µ–ø –ì–≤–∞—Ä–¥–∏–æ–ª–∞'},
        '–∞—Ä—Å–µ–Ω–∞–ª': {'—Å–∏–ª–∞': 92, '–∞—Ç–∞–∫–∞': 94, '–∑–∞—â–∏—Ç–∞': 90, '—Ç—Ä–µ–Ω–µ—Ä': '–ú–∏–∫–µ–ª—å –ê—Ä—Ç–µ—Ç–∞'},
        '–ª–∏–≤–µ—Ä–ø—É–ª—å': {'—Å–∏–ª–∞': 93, '–∞—Ç–∞–∫–∞': 95, '–∑–∞—â–∏—Ç–∞': 91, '—Ç—Ä–µ–Ω–µ—Ä': '–Æ—Ä–≥–µ–Ω –ö–ª–æ–ø–ø'},
        '—á–µ–ª—Å–∏': {'—Å–∏–ª–∞': 85, '–∞—Ç–∞–∫–∞': 83, '–∑–∞—â–∏—Ç–∞': 87, '—Ç—Ä–µ–Ω–µ—Ä': '–ú–∞—É—Ä–∏—Å–∏–æ –ü–æ—á–µ—Ç—Ç–∏–Ω–æ'},
        '–º–∞–Ω—á–µ—Å—Ç–µ—Ä —é–Ω–∞–π—Ç–µ–¥': {'—Å–∏–ª–∞': 82, '–∞—Ç–∞–∫–∞': 80, '–∑–∞—â–∏—Ç–∞': 84, '—Ç—Ä–µ–Ω–µ—Ä': '–≠—Ä–∏–∫ —Ç–µ–Ω –•–∞–≥'},
        '—Ç–æ—Ç—Ç–µ–Ω—Ö—ç–º': {'—Å–∏–ª–∞': 88, '–∞—Ç–∞–∫–∞': 90, '–∑–∞—â–∏—Ç–∞': 86, '—Ç—Ä–µ–Ω–µ—Ä': '–ê–Ω–≥–µ–ª–æ—Å –ü–æ—Å—Ç–µ–∫–æ–≥–ª—É'},
        '—ç–≤–µ—Ä—Ç–æ–Ω': {'—Å–∏–ª–∞': 75, '–∞—Ç–∞–∫–∞': 72, '–∑–∞—â–∏—Ç–∞': 78, '—Ç—Ä–µ–Ω–µ—Ä': '–®–æ–Ω –î–∞–π—á'},
        '–ª–∏–¥—Å': {'—Å–∏–ª–∞': 70, '–∞—Ç–∞–∫–∞': 73, '–∑–∞—â–∏—Ç–∞': 68, '—Ç—Ä–µ–Ω–µ—Ä': '–î–∞–Ω–∏—ç–ª—å –§–∞—Ä–∫–µ'},
        
        # –õ–∞ –õ–∏–≥–∞
        '—Ä–µ–∞–ª –º–∞–¥—Ä–∏–¥': {'—Å–∏–ª–∞': 96, '–∞—Ç–∞–∫–∞': 98, '–∑–∞—â–∏—Ç–∞': 94, '—Ç—Ä–µ–Ω–µ—Ä': '–ö–∞—Ä–ª–æ –ê–Ω—á–µ–ª–æ—Ç—Ç–∏'},
        '–±–∞—Ä—Å–µ–ª–æ–Ω–∞': {'—Å–∏–ª–∞': 94, '–∞—Ç–∞–∫–∞': 96, '–∑–∞—â–∏—Ç–∞': 92, '—Ç—Ä–µ–Ω–µ—Ä': '–•–∞–≤–∏ –≠—Ä–Ω–∞–Ω–¥–µ—Å'},
        '–∞—Ç–ª–µ—Ç–∏–∫–æ –º–∞–¥—Ä–∏–¥': {'—Å–∏–ª–∞': 89, '–∞—Ç–∞–∫–∞': 86, '–∑–∞—â–∏—Ç–∞': 92, '—Ç—Ä–µ–Ω–µ—Ä': '–î–∏–µ–≥–æ –°–∏–º–µ–æ–Ω–µ'},
        
        # –ë—É–Ω–¥–µ—Å–ª–∏–≥–∞
        '–±–∞–≤–∞—Ä–∏—è': {'—Å–∏–ª–∞': 97, '–∞—Ç–∞–∫–∞': 99, '–∑–∞—â–∏—Ç–∞': 95, '—Ç—Ä–µ–Ω–µ—Ä': '–¢–æ–º–∞—Å –¢—É—Ö–µ–ª—å'},
        '–±–æ—Ä—É—Å—Å–∏—è –¥–æ—Ä—Ç–º—É–Ω–¥': {'—Å–∏–ª–∞': 90, '–∞—Ç–∞–∫–∞': 92, '–∑–∞—â–∏—Ç–∞': 88, '—Ç—Ä–µ–Ω–µ—Ä': '–≠–¥–∏–Ω –¢–µ—Ä–∑–∏—á'},
        
        # –°–µ—Ä–∏—è –ê
        '–∏–Ω—Ç–µ—Ä': {'—Å–∏–ª–∞': 91, '–∞—Ç–∞–∫–∞': 90, '–∑–∞—â–∏—Ç–∞': 92, '—Ç—Ä–µ–Ω–µ—Ä': '–°–∏–º–æ–Ω–µ –ò–Ω–¥–∑–∞–≥–∏'},
        '–º–∏–ª–∞–Ω': {'—Å–∏–ª–∞': 89, '–∞—Ç–∞–∫–∞': 88, '–∑–∞—â–∏—Ç–∞': 90, '—Ç—Ä–µ–Ω–µ—Ä': '–°—Ç–µ—Ñ–∞–Ω–æ –ü–∏–æ–ª–∏'},
        '—é–≤–µ–Ω—Ç—É—Å': {'—Å–∏–ª–∞': 87, '–∞—Ç–∞–∫–∞': 85, '–∑–∞—â–∏—Ç–∞': 89, '—Ç—Ä–µ–Ω–µ—Ä': '–ú–∞—Å—Å–∏–º–∏–ª–∏–∞–Ω–æ –ê–ª–ª–µ–≥—Ä–∏'},
        
        # –†–ü–õ
        '–∑–µ–Ω–∏—Ç': {'—Å–∏–ª–∞': 88, '–∞—Ç–∞–∫–∞': 87, '–∑–∞—â–∏—Ç–∞': 89, '—Ç—Ä–µ–Ω–µ—Ä': '–°–µ—Ä–≥–µ–π –°–µ–º–∞–∫'},
        '—Å–ø–∞—Ä—Ç–∞–∫': {'—Å–∏–ª–∞': 85, '–∞—Ç–∞–∫–∞': 86, '–∑–∞—â–∏—Ç–∞': 84, '—Ç—Ä–µ–Ω–µ—Ä': '–ì–∏–ª—å–µ—Ä–º–æ –ê–±–∞—Å–∫–∞–ª—å'},
        '—Ü—Å–∫–∞': {'—Å–∏–ª–∞': 83, '–∞—Ç–∞–∫–∞': 82, '–∑–∞—â–∏—Ç–∞': 84, '—Ç—Ä–µ–Ω–µ—Ä': '–í–ª–∞–¥–∏–º–∏—Ä –§–µ–¥–æ—Ç–æ–≤'},
        '–ª–æ–∫–æ–º–æ—Ç–∏–≤': {'—Å–∏–ª–∞': 82, '–∞—Ç–∞–∫–∞': 81, '–∑–∞—â–∏—Ç–∞': 83, '—Ç—Ä–µ–Ω–µ—Ä': '–ú–∏—Ö–∞–∏–ª –ì–∞–ª–∞–∫—Ç–∏–æ–Ω–æ–≤'},
    }
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
    words = match_lower.split()
    
    # –ò—â–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —Å–ª–æ–≤–∞—Ä–µ
    found_teams = []
    for word in words:
        for team_name, stats in teams.items():
            if word in team_name or team_name in match_lower:
                found_teams.append((team_name, stats))
    
    # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    unique_teams = []
    seen = set()
    for team in found_teams:
        if team[0] not in seen:
            seen.add(team[0])
            unique_teams.append(team)
    
    if len(unique_teams) >= 2:
        team1, stats1 = unique_teams[0]
        team2, stats2 = unique_teams[1]
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–≤–æ—Ä–∏—Ç–∞
        if stats1['—Å–∏–ª–∞'] > stats2['—Å–∏–ª–∞']:
            winner = team1.title()
            loser = team2.title()
            win_prob = stats1['—Å–∏–ª–∞'] / (stats1['—Å–∏–ª–∞'] + stats2['—Å–∏–ª–∞'])
        else:
            winner = team2.title()
            loser = team1.title()
            win_prob = stats2['—Å–∏–ª–∞'] / (stats1['—Å–∏–ª–∞'] + stats2['—Å–∏–ª–∞'])
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        score_diff = abs(stats1['—Å–∏–ª–∞'] - stats2['—Å–∏–ª–∞'])
        
        if score_diff > 20:  # –°–∏–ª—å–Ω—ã–π —Ñ–∞–≤–æ—Ä–∏—Ç
            if stats1['—Å–∏–ª–∞'] > stats2['—Å–∏–ª–∞']:
                score = f"{random.randint(2, 4)}-{random.randint(0, 1)}"
            else:
                score = f"{random.randint(0, 1)}-{random.randint(2, 4)}"
        elif score_diff > 10:  # –£–º–µ—Ä–µ–Ω–Ω—ã–π —Ñ–∞–≤–æ—Ä–∏—Ç
            if stats1['—Å–∏–ª–∞'] > stats2['—Å–∏–ª–∞']:
                score = f"{random.randint(1, 3)}-{random.randint(0, 1)}"
            else:
                score = f"{random.randint(0, 1)}-{random.randint(1, 3)}"
        else:  # –†–∞–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            score = f"{random.randint(0, 2)}-{random.randint(0, 2)}"
        
        import random
        analysis_points = [
            f"–ò—Å—Ö–æ–¥—è –∏–∑ —Ç–µ–∫—É—â–µ–π —Ñ–æ—Ä–º—ã –∫–æ–º–∞–Ω–¥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ–∑–æ–Ω–∞",
            f"–£—á–∏—Ç—ã–≤–∞—è —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ö–µ–º—ã —Ç—Ä–µ–Ω–µ—Ä–æ–≤ –∏ —Å–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥",
            f"–ù–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏–≥—Ä–æ–∫–æ–≤",
            f"–° —É—á–µ—Ç–æ–º –¥–æ–º–∞—à–Ω–µ–≥–æ/–≥–æ—Å—Ç–µ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –º–∞—Ç—á–∞",
            f"–£—á–∏—Ç—ã–≤–∞—è —Ç—Ä–∞–≤–º—ã –∫–ª—é—á–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É"
        ]
        
        prediction = (
            f"üìä **–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—á–∞ {match_name}:**\n\n"
            f"üîç *–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:*\n"
            f"‚Ä¢ {random.choice(analysis_points)}\n"
            f"‚Ä¢ –°–∏–ª–∞ –∞—Ç–∞–∫–∏: {team1.title()} ({stats1['–∞—Ç–∞–∫–∞']}/100) vs {team2.title()} ({stats2['–∞—Ç–∞–∫–∞']}/100)\n"
            f"‚Ä¢ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∑–∞—â–∏—Ç—ã: {team1.title()} ({stats1['–∑–∞—â–∏—Ç–∞']}/100) vs {team2.title()} ({stats2['–∑–∞—â–∏—Ç–∞']}/100)\n\n"
            f"üéØ *–ü—Ä–æ–≥–Ω–æ–∑:*\n"
            f"‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å: **{winner}** (—à–∞–Ω—Å –ø–æ–±–µ–¥—ã: {win_prob*100:.1f}%)\n"
            f"‚Ä¢ –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Å—á–µ—Ç: **{score}**\n"
            f"‚Ä¢ –¢—Ä–µ–Ω–µ—Ä—Å–∫–æ–µ –ø—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è–Ω–∏–µ: {stats1['—Ç—Ä–µ–Ω–µ—Ä']} vs {stats2['—Ç—Ä–µ–Ω–µ—Ä']}\n\n"
            f"‚ö†Ô∏è *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:* –ü—Ä–æ–≥–Ω–æ–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –∫–æ–º–∞–Ω–¥. –†–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è."
        )
        
        return prediction
    else:
        # –ï—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ –∫–æ–º–∞–Ω–¥—ã
        import random
        scores = ["2-1", "1-0", "2-0", "1-1", "3-1", "2-2"]
        outcomes = [
            "–ø–æ–±–µ–¥–∞ —Ö–æ–∑—è–µ–≤ –≤ —É–ø–æ—Ä–Ω–æ–π –±–æ—Ä—å–±–µ",
            "–≥–æ—Å—Ç–µ–≤–æ–π —É—Å–ø–µ—Ö –∑–∞ —Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫",
            "–Ω–∏—á—å—è –≤ —Ä–∞–≤–Ω–æ–º –ø—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è–Ω–∏–∏",
            "–ø–æ–±–µ–¥–∞ –∑–∞ —Å—á–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≥–æ–ª–∞",
            "—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–∞—è –∏–≥—Ä–∞ —Å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ–º –æ–¥–Ω–æ–π –∏–∑ –∫–æ–º–∞–Ω–¥"
        ]
        
        return (
            f"‚öΩ **–ú–∞—Ç—á:** {match_name}\n\n"
            f"üìä *–ü—Ä–æ–≥–Ω–æ–∑:*\n"
            f"‚Ä¢ –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –º–∞—Ç—á –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å–æ —Å—á–µ—Ç–æ–º **{random.choice(scores)}**\n"
            f"‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω—ã–π –∏—Å—Ö–æ–¥: **{random.choice(outcomes)}**\n"
            f"‚Ä¢ –û–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–∞—è –∏–≥—Ä–∞ —Å –±–æ—Ä—å–±–æ–π –≤ —Ü–µ–Ω—Ç—Ä–µ –ø–æ–ª—è\n\n"
            f"üîç *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:* –î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥."
        )

@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    await message.answer(
        "ü§ñ **–§—É—Ç–±–æ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –±–æ—Ç**\n\n"
        "–Ø –º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–π —Ñ—É—Ç–±–æ–ª—å–Ω—ã–π –º–∞—Ç—á!\n\n"
        "üìù *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "‚Ä¢ –≠–≤–µ—Ä—Ç–æ–Ω –õ–∏–¥—Å\n"
        "‚Ä¢ –ë–∞—Ä—Å–µ–ª–æ–Ω–∞ –†–µ–∞–ª –ú–∞–¥—Ä–∏–¥\n"
        "‚Ä¢ –ú–∞–Ω—á–µ—Å—Ç–µ—Ä –Æ–Ω–∞–π—Ç–µ–¥ –õ–∏–≤–µ—Ä–ø—É–ª—å\n"
        "‚Ä¢ –ó–µ–Ω–∏—Ç –°–ø–∞—Ä—Ç–∞–∫ –ú–æ—Å–∫–≤–∞\n\n"
        "‚ö° *–ß—Ç–æ —è –¥–µ–ª–∞—é:*\n"
        "1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–∏–ª—É –∫–æ–º–∞–Ω–¥\n"
        "2. –î–∞—é –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è\n"
        "3. –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—é –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Å—á–µ—Ç\n"
        "4. –£—á–∏—Ç—ã–≤–∞—é —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã"
    )

@dp.message(Command("test"))
async def test_cmd(message: types.Message):
    """–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI"""
    await message.answer("üß™ –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI —Å–∏—Å—Ç–µ–º–∞–º...")
    
    working_models = await test_gemini_connection()
    
    if working_models:
        response = "‚úÖ **AI —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç:**\n" + "\n".join([f"‚Ä¢ {model}" for model in working_models[:3]])
    else:
        response = "‚ö†Ô∏è **AI —Å–∏—Å—Ç–µ–º—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.** –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É."
    
    await message.answer(response)

@dp.message(Command("–ø—Ä–∏–º–µ—Ä"))
async def example_cmd(message: types.Message):
    """–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
    examples = [
        "–≠–≤–µ—Ä—Ç–æ–Ω –õ–∏–¥—Å",
        "–ë–∞—Ä—Å–µ–ª–æ–Ω–∞ –†–µ–∞–ª –ú–∞–¥—Ä–∏–¥", 
        "–ú–∞–Ω—á–µ—Å—Ç–µ—Ä –Æ–Ω–∞–π—Ç–µ–¥ –õ–∏–≤–µ—Ä–ø—É–ª—å",
        "–ó–µ–Ω–∏—Ç –°–ø–∞—Ä—Ç–∞–∫",
        "–ê—Ä—Å–µ–Ω–∞–ª –ß–µ–ª—Å–∏",
        "–ë–∞–≤–∞—Ä–∏—è –ë–æ—Ä—É—Å—Å–∏—è –î–æ—Ä—Ç–º—É–Ω–¥"
    ]
    
    response = "üìã **–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:**\n\n" + "\n".join([f"‚Ä¢ `{ex}`" for ex in examples])
    await message.answer(response, parse_mode="Markdown")

@dp.message()
async def handle_message(message: types.Message):
    if not message.text or message.text.startswith('/'):
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç"
    await bot.send_chat_action(message.chat.id, "typing")
    
    print(f"\nüì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: '{message.text}'")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑
    prediction = await get_football_prediction(message.text)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    await message.answer(prediction, parse_mode="Markdown")
    
    print("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")

async def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    print("=" * 60)
    print("ü§ñ –ó–ê–ü–£–°–ö –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–û–ì–û –§–£–¢–ë–û–õ–¨–ù–û–ì–û –ë–û–¢–ê")
    print("=" * 60)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI
    await test_gemini_connection()
    
    # –û—á–∏—â–∞–µ–º –≤–µ–±—Ö—É–∫
    await bot.delete_webhook(drop_pending_updates=True)
    
    print("\n‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("üì± –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –≤ Telegram")
    print("=" * 60)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º polling
    try:
        await dp.start_polling(
            bot,
            skip_updates=True,
            allowed_updates=["message"],
            polling_timeout=30,
            relax=0.1
        )
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º random –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏
    import random
    
    try:
        import sys
        if sys.platform == "win32":
            asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    except:
        pass
    
    asyncio.run(main())
